<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Packet Forge — Neon Cyber Ops · CrackTheCode</title>
  <style>
    :root{
      --bg:#020008;
      --bg-panel:rgba(3,0,14,0.96);
      --accent:#5bffbf;
      --accent-soft:#2de4ff;
      --accent-alt:#ff5af2;
      --danger:#ff3366;
      --muted:#a0aec0;
      --border-soft:rgba(91,255,191,0.22);
      --font-mono:"Fira Code","JetBrains Mono",ui-monospace,Menlo,monospace;
      --font-ui:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",system-ui,sans-serif;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;}
    body{
      background:
        radial-gradient(circle at top left,rgba(255,90,242,0.12),transparent 55%),
        radial-gradient(circle at top right,rgba(45,228,255,0.14),transparent 60%),
        #020008;
      color:var(--accent);
      font-family:var(--font-mono);
      font-size:14px;
      -webkit-font-smoothing:antialiased;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:18px;
    }

    .scanlines{
      pointer-events:none;
      position:fixed;
      inset:0;
      background-image:linear-gradient(to bottom,rgba(255,255,255,0.03) 1px,transparent 3px);
      mix-blend-mode:soft-light;
      opacity:0.05;
      z-index:-1;
    }

    .container{
      width:100%;
      max-width:1440px;
      display:grid;
      grid-template-columns: minmax(0,1.9fr) minmax(260px,0.9fr);
      gap:16px;
      position:relative;
    }
    @media(max-width:1000px){
      .container{grid-template-columns:1fr;}
    }

    /* HEADER */
    .header{
      grid-column:1/-1;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:14px;
      margin-bottom:8px;
    }
    .title-block{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .logo-glitch{
      font-family:var(--font-ui);
      font-size:11px;
      letter-spacing:0.22em;
      color:var(--accent-alt);
      text-transform:uppercase;
    }
    .title{
      font-size:24px;
      color:var(--accent-soft);
      text-shadow:0 0 16px rgba(91,255,191,0.55);
    }
    .subtitle{
      font-family:var(--font-ui);
      font-size:14px;
      color:var(--muted);
    }
    .tagline{
      font-size:11px;
      color:var(--accent-alt);
      text-transform:uppercase;
      letter-spacing:0.12em;
    }
    .header-right{
      display:flex;
      flex-direction:column;
      gap:4px;
      align-items:flex-end;
      font-size:12px;
      color:var(--muted);
      font-family:var(--font-ui);
    }
    .pill{
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(91,255,191,0.3);
      color:var(--accent);
      font-size:10px;
      margin-left:4px;
    }
    .leds span{
      display:inline-block;
      width:8px;height:8px;
      border-radius:50%;
      margin-left:4px;
      background:#140014;
      box-shadow:0 0 6px #000 inset;
    }
    .leds span.on-green{
      background:#5bffbf;
      box-shadow:0 0 10px rgba(91,255,191,0.95);
    }
    .leds span.on-pink{
      background:#ff5af2;
      box-shadow:0 0 10px rgba(255,90,242,0.9);
    }

    /* LEFT COLUMN */
    .left{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .panel{
      background:var(--bg-panel);
      border-radius:16px;
      border:1px solid rgba(255,255,255,0.04);
      box-shadow:
        0 22px 80px rgba(0,0,0,0.96),
        0 0 24px rgba(255,90,242,0.14) inset;
      padding:12px;
    }

    /* Terminal */
    .terminal-wrap{
      display:flex;
      flex-direction:column;
      gap:8px;
      position:relative;
      overflow:hidden;
    }
    .terminal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:12px;
      color:var(--muted);
      font-family:var(--font-ui);
    }
    .terminal-header span strong{
      color:var(--accent-soft);
      font-weight:600;
    }
    .terminal-screen{
      margin-top:2px;
      flex:1;
      min-height:260px;
      max-height:360px;
      padding:10px;
      background:
        radial-gradient(circle at top left,rgba(255,90,242,0.16),transparent 90%),
        radial-gradient(circle at bottom right,rgba(45,228,255,0.10),transparent 95%),
        #02000a;
      border-radius:10px;
      border:1px solid rgba(91,255,191,0.16);
      overflow-y:auto;
      font-size:13px;
      line-height:1.6;
      color:#e4fff7;
      position:relative;
    }
    .terminal-screen::-webkit-scrollbar{width:7px;}
    .terminal-screen::-webkit-scrollbar-thumb{
      background:rgba(91,255,191,0.35);
      border-radius:20px;
    }
    .line{white-space:pre-wrap;word-break:break-word;}
    .user{color:var(--accent-soft);}
    .sys{color:var(--accent);}
    .lyra{color:var(--accent-alt);}
    .warn{color:var(--danger);}
    .dim{color:var(--muted);}
    .prompt-row{
      margin-top:6px;
      display:flex;
      align-items:center;
      gap:8px;
      font-size:13px;
      color:var(--accent-soft);
    }
    .prompt-label{flex-shrink:0;}
    #cmd{
      flex:1;
      background:transparent;
      border:none;
      outline:none;
      padding:4px 0;
      color:var(--accent);
      font-family:var(--font-mono);
      font-size:13px;
    }
    #cmd::placeholder{
      color:rgba(148,163,199,0.6);
    }

    /* Code panels */
    .code-panels{
      display:grid;
      grid-template-columns: minmax(0,1.4fr) minmax(0,1.1fr);
      gap:10px;
      margin-top:6px;
    }
    .code-block{
      background:radial-gradient(circle at top,rgba(0,255,191,0.06),transparent),
                 #040013;
      border-radius:10px;
      border:1px solid rgba(91,255,191,0.18);
      padding:8px;
      font-size:12px;
      color:var(--muted);
      min-height:110px;
    }
    .code-title{
      font-size:11px;
      color:var(--accent-soft);
      margin-bottom:4px;
      text-transform:uppercase;
      letter-spacing:0.1em;
    }
    pre.snippet{
      margin-top:2px;
      font-family:var(--font-mono);
      font-size:11px;
      color:#a5ffea;
      white-space:pre;
      overflow-x:auto;
    }

    /* RIGHT COLUMN */
    .right{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .hud-card{
      position:relative;
      background:
        radial-gradient(circle at top,rgba(255,90,242,0.18),transparent),
        radial-gradient(circle at bottom,rgba(45,228,255,0.12),transparent),
        rgba(3,0,18,0.98);
      border-radius:16px;
      padding:10px;
      border:1px solid rgba(255,255,255,0.05);
      box-shadow:
        0 20px 70px rgba(0,0,0,0.98),
        0 0 24px rgba(91,255,191,0.20) inset;
      font-size:12px;
      font-family:var(--font-ui);
      color:var(--muted);
      overflow:hidden;
    }
    .hud-label{
      font-size:10px;
      color:var(--accent-soft);
      letter-spacing:0.14em;
      text-transform:uppercase;
      margin-bottom:3px;
    }
    .hud-title{
      font-size:14px;
      color:var(--accent);
      margin-bottom:3px;
    }
    .hud-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:6px;
      margin-top:6px;
    }
    .hud-stat{
      padding:5px 6px;
      border-radius:8px;
      background:rgba(3,0,18,0.96);
      border:1px solid rgba(91,255,191,0.18);
      display:flex;
      flex-direction:column;
      gap:2px;
      font-size:10px;
    }
    .hud-stat-label{color:var(--muted);}
    .hud-stat-value{color:var(--accent);font-family:var(--font-mono);}

    .hud-mission-steps{
      margin-top:6px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .hud-step{
      display:flex;
      gap:5px;
      align-items:flex-start;
      font-size:11px;
    }
    .hud-dot{
      margin-top:4px;
      width:7px;height:7px;
      border-radius:50%;
      border:1px solid rgba(255,90,242,0.5);
      flex-shrink:0;
    }
    .hud-step.done .hud-dot{
      background:var(--accent-alt);
      box-shadow:0 0 6px rgba(255,90,242,0.9);
    }
    .hud-step.done span{
      color:var(--accent);
    }

    .hud-mini-log{
      margin-top:6px;
      padding:5px 6px;
      border-radius:8px;
      background:rgba(5,0,24,0.96);
      border:1px solid rgba(255,90,242,0.22);
      font-size:10px;
      max-height:90px;
      overflow:auto;
      color:var(--accent-soft);
    }

    .hud-wire{
      position:absolute;
      inset:auto -40px -14px;
      height:1px;
      background:linear-gradient(90deg,transparent,rgba(255,90,242,0.5),transparent);
      opacity:0.5;
      pointer-events:none;
    }

    .bar{
      margin-top:6px;
      width:100%;
      height:8px;
      border-radius:999px;
      background:rgba(10,10,20,0.98);
      overflow:hidden;
      border:1px solid rgba(91,255,191,0.22);
    }
    .bar-fill{
      height:100%;
      background:linear-gradient(90deg,var(--accent-alt),var(--accent-soft));
      width:0%;
    }

    .btn-compact{
      margin-top:6px;
      padding:5px 8px;
      font-size:10px;
      border-radius:999px;
      border:1px solid rgba(91,255,191,0.3);
      background:transparent;
      color:var(--accent-soft);
      cursor:pointer;
    }
    .btn-compact:hover{
      background:rgba(255,255,255,0.04);
      box-shadow:0 6px 22px rgba(0,0,0,0.9);
    }

    /* Map */
    #neonMap{
      margin-top:4px;
    }
  </style>
</head>
<body>
<div class="scanlines"></div>

<div class="container" id="pf-root">
  <!-- HEADER -->
  <div class="header">
    <div class="title-block">
      <div class="logo-glitch">CRACKTHECODE // NEON GRID OPS</div>
      <div class="title">Packet Forge — Neon Cyber Ops</div>
      <div class="subtitle">Simulateur d’attaque & défense 100% fictif. Vraies syntaxes, faux systèmes. Guidé par Lyra.exe.</div>
      <div class="tagline">AUCUNE ACTION RÉELLE — SANDBOX PÉDAGOGIQUE — UNIVERS AKIRA CITY</div>
    </div>
    <div class="header-right">
      <div>Session: <span id="uiPlayer">sam@neon-lab</span> <span class="pill">Story-linked</span></div>
      <div>Niveau opérateur: <span id="uiLevel">1</span> · Trace (fictive): <span id="uiTrace">0%</span></div>
      <div>Fragments Kali détectés: <span id="uiFragments">0</span></div>
      <div class="leds">
        <span class="on-green"></span>
        <span class="on-pink"></span>
        <span></span>
      </div>
    </div>
  </div>

  <!-- LEFT -->
  <div class="left">
    <div class="panel terminal-wrap">
      <div class="terminal-header">
        <span>NEON_TERM v2.7 — <strong>Akira Packet Forge</strong> — Tape <span class="dim">help</span> pour commencer.</span>
        <span>Syntaxes proches du réel, mais verrouillées dans ce sandbox.</span>
      </div>
      <div id="term" class="terminal-screen">
        <div class="line sys">[BOOT] Initialisation du Neon Grid...</div>
        <div class="line sys">[SYS] Chargement des noeuds fictifs : edge, dmz, core, ghost-arc, kali-link.</div>
        <div class="line lyra">[LYRA] Bienvenue Sam. Ici tu peux taper des lignes de code comme dans un vrai lab, mais rien ne sort de ce terminal.</div>
        <div class="line lyra">[LYRA] On forge des paquets, on lit des configs, on simule des scans. Tout reste 100% légal et narratif.</div>
      </div>
      <div class="prompt-row">
        <span class="prompt-label" id="prompt">sam@neon-lab:~/forge$</span>
        <input id="cmd" type="text"
               placeholder="help · mission · cat neon.conf · show firewall · forge --type probe --dst dmz.akiranet"
               autocomplete="off" spellcheck="false">
      </div>

      <div class="code-panels">
        <div class="code-block">
          <div class="code-title">SNIPPET ACTIF</div>
          <pre id="snippetActive" class="snippet">
# Tape `show firewall` ou `show ghostscan`
# pour afficher du pseudo-code réseau/Python simulé.
          </pre>
        </div>
        <div class="code-block">
          <div class="code-title">NOTES DE LYRA</div>
          <pre id="snippetLyra" class="snippet">
# Ici, tu t'entraînes à lire:
# - boucles Python qui sondent des hôtes fictifs
# - règles proches d'iptables
# - logs & patterns d'attaque vus côté défense
# Rien n'est exploitable hors de ce jeu.
          </pre>
        </div>
      </div>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="right">
    <!-- Mission HUD -->
    <div class="hud-card">
      <div class="hud-label">MISSION FEED</div>
      <div class="hud-title" id="hudMissionTitle">Initialisation de campagne</div>
      <div id="hudMissionDesc">
        Tu entres dans le Neon Lab. Tu joues une Red Team encadrée par Lyra en Blue Team.
        On t'apprend à lire, corréler, documenter. Pas à casser du vrai système.
      </div>
      <div class="hud-mission-steps" id="hudSteps"></div>
      <div class="hud-mini-log" id="hudMiniLog"></div>
      <div class="hud-wire"></div>
    </div>

    <!-- Stats HUD -->
    <div class="hud-card">
      <div class="hud-label">NEON STATS</div>
      <div class="hud-grid">
        <div class="hud-stat">
          <div class="hud-stat-label">XP simulée</div>
          <div class="hud-stat-value" id="hudXP">0</div>
        </div>
        <div class="hud-stat">
          <div class="hud-stat-label">Missions complétées</div>
          <div class="hud-stat-value" id="hudMissions">0</div>
        </div>
        <div class="hud-stat">
          <div class="hud-stat-label">Temps en dojo</div>
          <div class="hud-stat-value" id="hudTime">0h 0m</div>
        </div>
        <div class="hud-stat">
          <div class="hud-stat-label">Alertes (fictives)</div>
          <div class="hud-stat-value" id="hudAlerts">0</div>
        </div>
      </div>
      <div class="bar"><div id="hudXPBar" class="bar-fill"></div></div>
      <button id="btnSave" class="btn-compact">Sauvegarder</button>
      <button id="btnLoad" class="btn-compact">Charger</button>
      <button id="btnReset" class="btn-compact">Reset campagne</button>
    </div>

    <!-- Map HUD -->
    <div class="hud-card">
      <div class="hud-label">NEON GRID MAP</div>
      <div class="hud-title">Flux simulés</div>
      <svg id="neonMap" viewBox="0 0 200 120" style="width:100%;height:90px;margin-top:4px;">
        <defs>
          <linearGradient id="glow" x1="0" x2="1">
            <stop offset="0%" stop-color="#ff5af2" stop-opacity="0"/>
            <stop offset="40%" stop-color="#ff5af2" stop-opacity="0.9"/>
            <stop offset="80%" stop-color="#2de4ff" stop-opacity="0.9"/>
            <stop offset="100%" stop-color="#2de4ff" stop-opacity="0"/>
          </linearGradient>
        </defs>
        <g stroke="url(#glow)" stroke-width="1.5" fill="none">
          <path d="M20 60 C60 10, 140 10, 180 60" />
          <path d="M20 60 C60 110, 140 110, 180 60" />
        </g>
        <g>
          <rect x="10" y="50" width="34" height="20" rx="4"
                fill="#050013" stroke="#5bffbf" stroke-width="0.6"/>
          <text x="13" y="63" fill="#5bffbf" font-size="7">EDGE</text>
        </g>
        <g>
          <rect x="80" y="6" width="48" height="18" rx="4"
                fill="#050013" stroke="#2de4ff" stroke-width="0.5"/>
          <text x="83" y="18" fill="#2de4ff" font-size="7">SCAN HUB</text>
        </g>
        <g>
          <rect x="150" y="50" width="38" height="20" rx="4"
                fill="#050013" stroke="#ff5af2" stroke-width="0.6"/>
          <text x="153" y="63" fill="#ff5af2" font-size="7">DMZ</text>
        </g>
        <g id="pktLayer"></g>
      </svg>
      <div class="small" style="margin-top:6px;">
        Les points néon représentent les paquets que tu forges avec des syntaxes réalistes,
        mais vers des noeuds inventés uniquement.
      </div>
      <button id="btnReplay" class="btn-compact">Replay local</button>
    </div>
  </div>
</div>

<script>
(function(){
  "use strict";

  const AUTOSAVE_KEY = "ctc_neon_packetforge_v1b";

  const termEl = document.getElementById("term");
  const cmdEl = document.getElementById("cmd");
  const promptEl = document.getElementById("prompt");
  const hudMissionTitle = document.getElementById("hudMissionTitle");
  const hudMissionDesc = document.getElementById("hudMissionDesc");
  const hudStepsEl = document.getElementById("hudSteps");
  const hudMiniLog = document.getElementById("hudMiniLog");
  const hudXP = document.getElementById("hudXP");
  const hudMissions = document.getElementById("hudMissions");
  const hudTime = document.getElementById("hudTime");
  const hudAlerts = document.getElementById("hudAlerts");
  const hudXPBar = document.getElementById("hudXPBar");
  const uiLevel = document.getElementById("uiLevel");
  const uiTrace = document.getElementById("uiTrace");
  const uiFragments = document.getElementById("uiFragments");
  const snippetActive = document.getElementById("snippetActive");
  const snippetLyra = document.getElementById("snippetLyra");
  const pktLayer = document.getElementById("pktLayer");
  const neonMap = document.getElementById("neonMap");
  const btnSave = document.getElementById("btnSave");
  const btnLoad = document.getElementById("btnLoad");
  const btnReset = document.getElementById("btnReset");
  const btnReplay = document.getElementById("btnReplay");

  const state = {
    level:1,
    xp:0,
    missionsDone:0,
    trace:0,
    alerts:0,
    fragments:0,
    playSeconds:0,
    lastTick:Date.now(),
    mission:null,
    timeline:[],
    packets:[],
    logs:[]
  };

  function log(msg, cls){
    const div = document.createElement("div");
    div.className = "line " + (cls||"");
    div.textContent = msg;
    termEl.appendChild(div);
    termEl.scrollTop = termEl.scrollHeight;
    state.logs.push({t:Date.now(), msg, cls});
    if(state.logs.length>1500) state.logs.shift();
  }
  const logSys = m=>log(m,"sys");
  const logLyra = m=>log(m,"lyra");
  const logWarn = m=>log(m,"warn");
  const logUser = m=>log("> "+m,"user");

  function hudLog(msg){
    const d = document.createElement("div");
    d.textContent = msg;
    hudMiniLog.appendChild(d);
    hudMiniLog.scrollTop = hudMiniLog.scrollHeight;
  }

  function addTimeline(ev){
    state.timeline.push({t:Date.now(), ev});
    if(state.timeline.length>600) state.timeline.shift();
  }

  function fmtTime(s){
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    return `${h}h ${m}m`;
  }

  function updateHUD(){
    hudXP.textContent = state.xp;
    hudMissions.textContent = state.missionsDone;
    hudTime.textContent = fmtTime(state.playSeconds);
    hudAlerts.textContent = state.alerts;
    uiLevel.textContent = state.level;
    uiTrace.textContent = state.trace+"%";
    uiFragments.textContent = state.fragments;
    const pct = Math.min(100, (state.xp % 800) / 8);
    hudXPBar.style.width = pct + "%";
  }

  // Missions
  function createMission(){
    const id = "M-"+Math.random().toString(36).slice(2,6).toUpperCase();
    const steps = [
      {id:"read-conf", label:'Lire la config: `cat neon.conf` puis `show firewall`.', done:false},
      {id:"probe-dmz", label:'Forger une sonde: `forge --type probe --dst dmz.akiranet` puis `send`.', done:false},
      {id:"analyze-ghost", label:'Afficher `show ghostscan` puis `report` pour conclure.', done:false}
    ];
    state.mission = {
      id,
      title:`Opération ${id} — Cartographie Neon`,
      desc:`Utilise des lignes de code réalistes pour explorer un réseau imaginaire et rédiger un rapport.`,
      steps
    };
    renderMissionUI();
    logLyra(`[LYRA] Nouvelle mission: ${state.mission.title}`);
    hudLog("Mission "+id+" initialisée.");
  }

  function renderMissionUI(){
    if(!state.mission) return;
    hudMissionTitle.textContent = state.mission.title;
    hudMissionDesc.textContent = state.mission.desc;
    hudStepsEl.innerHTML = "";
    state.mission.steps.forEach(st=>{
      const row = document.createElement("div");
      row.className = "hud-step"+(st.done?" done":"");
      row.innerHTML = `<div class="hud-dot"></div><span>${st.label}</span>`;
      hudStepsEl.appendChild(row);
    });
    updateHUD();
  }

  function markStep(id){
    if(!state.mission) return;
    const st = state.mission.steps.find(s=>s.id===id);
    if(st && !st.done){
      st.done = true;
      hudLog("Objectif atteint: "+st.label);
      logLyra("[LYRA] Objectif validé.");
      renderMissionUI();
      checkMissionComplete();
    }
  }

  function checkMissionComplete(){
    if(!state.mission) return;
    if(state.mission.steps.every(s=>s.done)){
      const reward = 200;
      state.xp += reward;
      state.missionsDone++;
      state.level = 1 + Math.floor(state.xp / 800);
      logSys(`[SYS] Mission ${state.mission.id} complétée. +${reward} XP (fictif).`);
      logLyra("[LYRA] Tu commences à penser comme un analyste, pas comme un script kiddie.");
      hudLog("Mission "+state.mission.id+" complétée.");
      state.mission = null;
      setTimeout(createMission, 800);
      updateHUD();
      saveState();
    }
  }

  // Packets
  function forgePacket(args){
    let type="probe", dst="dmz.akiranet";
    for(let i=0;i<args.length;i++){
      if(args[i]==="--type" && args[i+1]) type=args[i+1];
      if((args[i]==="--dst"||args[i]==="--target") && args[i+1]) dst=args[i+1];
    }
    const pkt = {
      id:"pkt-"+Math.random().toString(36).slice(2,7),
      type,dst,
      t:Date.now()
    };
    state.packets.push(pkt);
    logSys(`[FORGE] ${pkt.id} type=${type} -> ${dst} (sandbox).`);
    hudLog(`Forge ${pkt.id} -> ${dst}`);
    addTimeline("forge "+pkt.id);
    animatePacket(pkt);
    if(type==="probe" && dst==="dmz.akiranet") markStep("probe-dmz");
    return pkt;
  }

  function sendLast(){
    const pkt = state.packets[state.packets.length-1];
    if(!pkt){
      logWarn("[ERR] Aucun paquet forgé.");
      return;
    }
    logSys(`[SEND] ${pkt.id} poussé vers ${pkt.dst} (virtuel).`);
    hudLog("Send "+pkt.id);
    addTimeline("send "+pkt.id);
    evaluatePacket(pkt);
  }

  function evaluatePacket(pkt){
    if(pkt.type==="probe" && pkt.dst==="dmz.akiranet"){
      logSys("[ANALYSE] Sonde propre sur la DMZ fictive. Lecture uniquement.");
    }
    if(pkt.type==="exfil"){
      logWarn("[ALERTE] Pattern EXFIL détecté (simulation). En vrai, ce serait critique.");
      state.alerts++;
      state.trace = Math.min(100, state.trace+15);
      uiTrace.textContent = state.trace+"%";
      hudAlerts.textContent = state.alerts;
      if(state.trace>=100){
        logWarn("[SYS] Trace MAX. Reset soft de la simulation.");
        softResetTrace();
      }
    }
  }

  function animatePacket(pkt){
    if(!neonMap || !pktLayer) return;
    const ns = "http://www.w3.org/2000/svg";
    const c = document.createElementNS(ns,"circle");
    c.setAttribute("r","2.8");
    c.setAttribute("fill", pkt.type==="exfil" ? "#ff3366" : "#5bffbf");
    pktLayer.appendChild(c);
    const start={x:20,y:60}, end={x:180,y:60};
    const c1={x:80,y:pkt.type==="exfil"?20:15};
    const c2={x:120,y:pkt.type==="exfil"?100:105};
    let t=0, speed=0.02;
    function bez(a,b,c,d,t){
      const mt=1-t;
      return mt*mt*mt*a + 3*mt*mt*t*b + 3*mt*t*t*c + t*t*t*d;
    }
    function step(){
      t+=speed;
      if(t>=1){ pktLayer.removeChild(c); return; }
      const x=bez(start.x,c1.x,c2.x,end.x,t);
      const y=bez(start.y,c1.y,c2.y,end.y,t);
      c.setAttribute("cx",x);
      c.setAttribute("cy",y);
      requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
  }

  function softResetTrace(){
    state.trace = 0;
    uiTrace.textContent = "0%";
    hudAlerts.textContent = state.alerts;
    logSys("[SYS] Trace remise à zéro. Tu peux continuer proprement.");
  }

  // Snippets
  function setSnippetActive(code){ snippetActive.textContent = code; }
  function setSnippetLyra(code){ snippetLyra.textContent = code; }

  function showFirewallSnippet(){
    setSnippetActive(
`# neon.conf (fictif)
firewall = [
  "allow edge -> dmz 80,443",
  "allow scan-hub -> dmz 443",
  "deny any -> core archives",
  "# log toute tentative EXFIL"
]`);
    setSnippetLyra(
`# LYRA:
# C'est ce qu'on veut que tu comprennes:
# lire et raisonner sur les règles,
# pas juste lancer des commandes au hasard.`);
  }

  function showGhostScanSnippet(){
    setSnippetActive(
`# ghostscan.py (sandbox)

hosts = ["ghost-arc", "dmz.akiranet", "ally-hub"]
for h in hosts:
    resp = probe(h)   # fonction simulée
    log(h, resp)`);
    setSnippetLyra(
`# LYRA:
# Boucle sur des hôtes, journalisation.
# En vrai: toujours avec autorisation,
# et toujours documenté.`);
  }

  // Commands
  function handleCommand(input){
    const line = (input||"").trim();
    if(!line) return;
    logUser(line);
    addTimeline("cmd "+line);
    const parts = line.split(/\s+/);
    const cmd = parts[0];
    const args = parts.slice(1);

    switch(cmd){
      case "help":
        logSys("Commandes (simulées) :");
        logSys("  help           : cette aide");
        logSys("  mission        : afficher les objectifs");
        logSys("  cat neon.conf  : lire la config fictive");
        logSys("  show firewall  : voir les règles simulées");
        logSys("  show ghostscan : voir un script pédagogique");
        logSys("  forge --type T --dst H  : forger un paquet");
        logSys("  send           : envoyer le dernier paquet");
        logSys("  report         : valider ton analyse");
        logSys("  replay         : voir l'historique local");
        logSys("  clear          : nettoyer l'écran");
        logLyra("[LYRA] Tu peux écrire de vraies syntaxes, mais retiens que tout est enfermé ici.");
        break;

      case "mission":
        renderMissionUI();
        break;

      case "cat":
        if(args[0]==="neon.conf"){
          logSys("[FILE] neon.conf (fictif)");
          logSys("MODE = TRAINING_NEON");
          logSys("NODES = edge, dmz, core, ghost-arc, kali-link");
          logSys("OUT_OF_SCOPE = everything_real_world");
          markStep("read-conf");
        } else {
          logWarn("cat: fichier inconnu dans ce lab.");
        }
        break;

      case "show":
        if(args[0]==="firewall"){
          showFirewallSnippet();
          logSys("Règles firewall fictives affichées.");
          markStep("read-conf");
        } else if(args[0]==="ghostscan"){
          showGhostScanSnippet();
          logSys("Script ghostscan fictif affiché.");
          markStep("analyze-ghost");
        } else {
          logWarn("show: ressource inconnue.");
        }
        break;

      case "forge":
        forgePacket(args);
        break;

      case "send":
        sendLast();
        break;

      case "report":
        logSys("[REPORT] Rapport fictif rédigé.");
        logLyra("[LYRA] C'est la compétence clé: expliquer ce que tu vois.");
        markStep("analyze-ghost");
        markStep("probe-dmz");
        checkMissionComplete();
        break;

      case "replay":
        replayTimeline();
        break;

      case "clear":
        termEl.innerHTML = "";
        break;

      default:
        logWarn("Commande inconnue dans ce simulateur. Tape `help`.");
    }
  }

  function replayTimeline(){
    logSys("[REPLAY] Dernières actions locales :");
    state.timeline.slice(-20).forEach(e=>{
      logSys(" - "+new Date(e.t).toLocaleTimeString()+" · "+e.ev);
    });
  }

  // Save / Load
  function saveState(){
    try{
      const data = {
        level:state.level,
        xp:state.xp,
        missionsDone:state.missionsDone,
        trace:state.trace,
        alerts:state.alerts,
        fragments:state.fragments,
        playSeconds:state.playSeconds,
        mission:state.mission
      };
      localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(data));
      hudLog("Sauvegarde locale OK.");
    }catch(e){
      logWarn("Erreur sauvegarde: "+e.message);
    }
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(AUTOSAVE_KEY);
      if(!raw){ logWarn("Aucune sauvegarde trouvée."); return; }
      const d = JSON.parse(raw);
      state.level = d.level||1;
      state.xp = d.xp||0;
      state.missionsDone = d.missionsDone||0;
      state.trace = d.trace||0;
      state.alerts = d.alerts||0;
      state.fragments = d.fragments||0;
      state.playSeconds = d.playSeconds||0;
      state.mission = d.mission||null;
      if(!state.mission) createMission();
      renderMissionUI();
      updateHUD();
      hudLog("Sauvegarde chargée.");
      logSys("[SYS] État restauré.");
    }catch(e){
      logWarn("Erreur chargement: "+e.message);
    }
  }

  function resetAll(){
    if(!confirm("Reset complet de la campagne locale ?")) return;
    localStorage.removeItem(AUTOSAVE_KEY);
    location.reload();
  }

  // Time tick
  setInterval(()=>{
    const now = Date.now();
    const dt = Math.floor((now - state.lastTick)/1000);
    if(dt>0){
      state.lastTick = now;
      state.playSeconds += dt;
      if(state.playSeconds % 30 === 0) saveState();
      updateHUD();
    }
  },1000);

  // Init
  function boot(){
    logSys("[SYS] Neon Cyber Ops prêt. Tape `help` ou `mission`.");
    if(localStorage.getItem(AUTOSAVE_KEY)){
      logLyra("[LYRA] Sauvegarde détectée. Utilise le bouton Charger pour reprendre.");
    }
    createMission();
    updateHUD();
  }

  const root = document.getElementById("pf-root");
  root.addEventListener("click", e=>{
    if(e.target!==cmdEl){
      setTimeout(()=>cmdEl.focus(),20);
    }
  });

  cmdEl.addEventListener("keydown", e=>{
    if(e.key==="Enter"){
      const v = cmdEl.value;
      cmdEl.value = "";
      handleCommand(v);
    }
  });

  btnSave.addEventListener("click", saveState);
  btnLoad.addEventListener("click", loadState);
  btnReset.addEventListener("click", resetAll);
  btnReplay.addEventListener("click", replayTimeline);

  boot();
})();
</script>
</body>
</html>
