<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Packet Forge — CrackTheCode (Simulateur pédagogique)</title>
<style>
:root{
  --bg:#050608; --panel:#071018; --glass:rgba(255,255,255,0.02);
  --accent:#8cffb8; --accent2:#39d6ff; --muted:#90a3a2; --danger:#ff6b8a;
  --card:#08121a; --shadow:rgba(0,0,0,0.7);
  --mono: "Fira Code", "JetBrains Mono", ui-monospace, Menlo, monospace;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:radial-gradient(circle at top left,#051018 0,#000 60%);color:var(--accent);font-family:var(--mono);-webkit-font-smoothing:antialiased}
.container{max-width:1400px;margin:18px auto;padding:12px;display:grid;grid-template-columns:1fr 420px;gap:12px;}
.header{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center;gap:12px}
.h-left{display:flex;flex-direction:column}
.title{font-size:20px;color:var(--accent2);letter-spacing:0.06em}
.subtitle{font-size:12px;color:var(--muted);margin-top:4px}
.controls{display:flex;gap:8px;align-items:center}
.btn{background:transparent;border:1px solid rgba(140,255,184,0.08);padding:8px 10px;border-radius:8px;color:var(--accent);cursor:pointer;font-size:13px}
.btn:hover{border-color:rgba(140,255,184,0.18);box-shadow:0 6px 30px var(--shadow) inset}
.btn-primary{background:linear-gradient(90deg,var(--accent)10%,var(--accent2)80%);color:#042426;border:none}
.board{background:linear-gradient(180deg,var(--panel),#02060a);border-radius:12px;padding:12px;border:1px solid rgba(140,255,184,0.06);box-shadow:0 20px 60px rgba(0,0,0,0.8)}
.left{display:flex;flex-direction:column;gap:12px}
.terminal{height:320px;overflow:auto;padding:12px;border-radius:8px;background:linear-gradient(180deg,#020606,#041018);border:1px solid rgba(57,214,255,0.05)}
.terminal .line{font-size:12px;color:var(--muted);line-height:1.5}
.terminal .sys{color:var(--accent2)}
.terminal .lyra{color:var(--accent)}
.controls-row{display:flex;gap:8px;align-items:center}
.toolbar{display:flex;gap:8px;align-items:center}
.tools{display:flex;gap:6px}
.panel{padding:10px;border-radius:8px;background:linear-gradient(180deg,#021018,#001015);border:1px solid rgba(0,0,0,0.3);min-height:120px}
.map{height:300px;border-radius:8px;background:linear-gradient(180deg,#051018,#001010);display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
.map svg{width:100%;height:100%}
.side{display:flex;flex-direction:column;gap:12px}
.info{font-size:13px;color:var(--muted)}
.mission-title{font-size:13px;color:var(--accent);margin-bottom:6px}
.obj{display:flex;gap:8px;align-items:flex-start}
.bullet{width:10px;height:10px;border-radius:50%;border:1px solid rgba(140,255,184,0.12)}
.bullet.done{background:var(--accent)}
.small{font-size:12px;color:var(--muted)}
.levelbar{height:10px;background:linear-gradient(90deg,#011 0,#042 100%);border-radius:99px;overflow:hidden;border:1px solid rgba(0,0,0,0.5)}
.progress{height:100%;background:linear-gradient(90deg,var(--accent)0,var(--accent2)100%);width:0%}
.debug{font-size:11px;color:var(--muted);background:rgba(255,255,255,0.01);padding:8px;border-radius:8px;max-height:160px;overflow:auto}
.row{display:flex;gap:8px;align-items:center}
.legend{display:flex;gap:6px;align-items:center;color:var(--muted);font-size:12px}
.legend .box{width:10px;height:10px;border-radius:2px}
.footer{grid-column:1/-1;margin-top:8px;color:var(--muted);font-size:12px}
.savebox{display:flex;gap:6px;align-items:center}
.switch{display:inline-flex;align-items:center;gap:8px;padding:6px 8px;border-radius:8px;border:1px solid rgba(140,255,184,0.06)}
kbd{background:#011214;border-radius:4px;padding:3px 5px;color:var(--accent2);font-weight:600;font-size:12px}
.note{font-size:12px;color:var(--muted);line-height:1.4}
@media(max-width:1100px){.container{grid-template-columns:1fr;}}
/* small helper */
.hint{color:var(--accent2);font-weight:600}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="h-left">
      <div class="title">Packet Forge — Simulateur Pédagogique (Sandbox)</div>
      <div class="subtitle">Campagne longue · sauvegarde · Red vs Blue · Pas d'accès réel · Univers CrackTheCode</div>
    </div>
    <div class="controls">
      <div class="legend">
        <div class="box" style="background:var(--accent)"></div><div>Vos paquets</div>
      </div>
      <button id="btnPause" class="btn">Pause</button>
      <button id="btnSave" class="btn">Sauvegarder</button>
      <button id="btnLoad" class="btn">Charger</button>
      <button id="btnExport" class="btn">Exporter</button>
      <button id="btnImport" class="btn">Importer</button>
      <button id="btnReset" class="btn">Reset campagne</button>
    </div>
  </div>

  <!-- left: main gameplay -->
  <div class="left board">
    <div style="display:flex;gap:12px;align-items:flex-start">
      <div style="flex:1">
        <div class="panel">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
            <div><strong class="small">Terminal Virtuel — Packet Forge</strong></div>
            <div class="small">Session : <span id="playerName">Sam</span> · Niveau : <span id="playerLevel">1</span></div>
          </div>
          <div id="terminal" class="terminal" aria-live="polite"></div>
          <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
            <input id="cmd" placeholder="help · mission · forge · send · inspect · block · replay · status" style="flex:1;padding:8px;border-radius:8px;background:rgba(0,0,0,0.25);border:1px solid rgba(140,255,184,0.04);color:var(--accent);font-family:var(--mono)"/>
            <button id="btnRun" class="btn btn-primary">Exécuter</button>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 320px;gap:12px;margin-top:12px">
          <div class="panel">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div class="small">Éditeur de Paquets (FICTIF)</div>
              <div class="small">Outils débloqués : <span id="toolsUnlocked">Basic Forge</span></div>
            </div>
            <div style="display:flex;gap:8px;flex-direction:column">
              <label class="small">Type d'action</label>
              <select id="pktType" style="padding:8px;border-radius:6px;background:rgba(0,0,0,0.12);color:var(--accent)">
                <option value="handshake">Handshake (simulé)</option>
                <option value="probe">Probe</option>
                <option value="beacon">Beacon</option>
                <option value="exfil">Exfil (fictif)</option>
                <option value="forge">Forge payload (teaching)</option>
              </select>
              <label class="small">Cible</label>
              <input id="pktTarget" style="padding:8px;border-radius:6px;background:rgba(0,0,0,0.12);color:var(--accent)" placeholder="dmz.akiranet"/>
              <label class="small">Priorité (1-10)</label>
              <input id="pktPrio" type="number" min="1" max="10" value="5" style="width:90px;padding:6px;border-radius:6px;background:rgba(0,0,0,0.12);color:var(--accent)"/>
              <div style="display:flex;gap:8px;margin-top:6px">
                <button id="btnForge" class="btn">Forge</button>
                <button id="btnSendPkt" class="btn">Envoyer</button>
              </div>
            </div>
          </div>

          <div class="panel">
            <div class="small" style="margin-bottom:6px">Timeline & Replay</div>
            <div id="timeline" class="debug"></div>
            <div style="margin-top:6px;display:flex;gap:6px;align-items:center">
              <button id="btnReplay" class="btn">Replay dernière mission</button>
              <button id="btnExportLog" class="btn">Exporter log</button>
            </div>
          </div>
        </div>
      </div>

      <!-- right column: map & mission -->
      <div class="side">
        <div class="panel map" id="mapPanel">
          <!-- svg map -->
          <svg id="mapSVG" viewBox="0 0 600 400" preserveAspectRatio="xMidYMid meet">
            <!-- links -->
            <g id="links" stroke="rgba(57,214,255,0.12)" stroke-width="2" fill="none">
              <path d="M60,200 C160,80 440,80 540,200" />
              <path d="M60,200 C160,320 440,320 540,200" />
            </g>

            <!-- nodes -->
            <g id="nodes">
              <g id="edge" transform="translate(40,180)">
                <rect x="0" y="0" width="80" height="40" rx="8" fill="#052225" stroke="#033" />
                <text x="12" y="25" fill="#7fffc8" font-size="12">EDGE</text>
              </g>
              <g id="scanhub" transform="translate(250,60)">
                <rect x="0" y="0" width="110" height="40" rx="8" fill="#041225" stroke="#035" />
                <text x="10" y="25" fill="#7fffc8" font-size="12">SCAN HUB</text>
              </g>
              <g id="dmz" transform="translate(460,160)">
                <rect x="0" y="0" width="110" height="40" rx="8" fill="#071224" stroke="#036" />
                <text x="10" y="25" fill="#7fffc8" font-size="12">DMZ</text>
              </g>
              <g id="core" transform="translate(260,260)">
                <rect x="0" y="0" width="120" height="44" rx="8" fill="#081226" stroke="#048" />
                <text x="12" y="28" fill="#7fffc8" font-size="12">CORE ARCHIVES</text>
              </g>
            </g>

            <!-- packets layer -->
            <g id="packetsLayer"></g>
          </svg>
        </div>

        <div class="panel">
          <div class="mission-title">Campagne · Mission actuelle</div>
          <div id="missionText" class="note small">Génération en cours...</div>
          <div style="margin-top:8px">
            <div class="obj" style="margin-bottom:6px">
              <div id="b1" class="bullet"></div>
              <div id="o1" class="small">Objectif 1</div>
            </div>
            <div class="obj" style="margin-bottom:6px">
              <div id="b2" class="bullet"></div>
              <div id="o2" class="small">Objectif 2</div>
            </div>
            <div class="obj" style="margin-bottom:6px">
              <div id="b3" class="bullet"></div>
              <div id="o3" class="small">Objectif 3</div>
            </div>
          </div>

          <div style="margin-top:8px">
            <div class="small">Progression de la campagne</div>
            <div class="levelbar" style="margin-top:6px"><div class="progress" id="xpProgress"></div></div>
            <div style="margin-top:6px" class="small">XP: <span id="xp">0</span> · Joué: <span id="playTime">0h</span></div>
          </div>

          <div style="margin-top:8px" class="savebox">
            <div class="small">Auto-save</div>
            <div id="autosaveStatus" class="small" style="color:var(--muted)">OK</div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div class="footer">
    <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
      <div class="note">Tout contenu est fictif / pédagogique. Le jeu n'exécute **aucune** commande réelle ni n'accède à l'Internet.</div>
      <div class="small">CrackTheCode — Sam & Lyra.exe</div>
    </div>
  </div>
</div>

<script>
/*
  PACKET FORGE - Client-side simulated campaign
  - Procedural missions
  - Simulated packets (no real network calls)
  - Save / load via localStorage
  - Long campaign: mission generator produces many challenges to reach multiple hours
  - Safety: all operations are simulated and non-actionable
*/

(function(){
  'use strict';

  // ---------- Core state ----------
  const state = {
    player: { name: 'Sam', level:1, xp:0, playSeconds:0 },
    mission: null,
    paused: false,
    timeline: [],
    logs: [],
    packets: [],
    autosaveKey: 'ctc_packetforge_save_v1',
    lastTick: Date.now()
  };

  // ---------- DOM refs ----------
  const terminalEl = document.getElementById('terminal');
  const cmdEl = document.getElementById('cmd');
  const btnRun = document.getElementById('btnRun');
  const btnForge = document.getElementById('btnForge');
  const btnSendPkt = document.getElementById('btnSendPkt');
  const pktTypeEl = document.getElementById('pktType');
  const pktTargetEl = document.getElementById('pktTarget');
  const pktPrioEl = document.getElementById('pktPrio');
  const packetsLayer = document.getElementById('packetsLayer');
  const missionText = document.getElementById('missionText');
  const b1 = document.getElementById('b1'), b2 = document.getElementById('b2'), b3 = document.getElementById('b3');
  const o1 = document.getElementById('o1'), o2 = document.getElementById('o2'), o3 = document.getElementById('o3');
  const xpEl = document.getElementById('xp'), xpBar = document.getElementById('xpProgress'), playTimeEl = document.getElementById('playTime');
  const btnPause = document.getElementById('btnPause'), btnSave = document.getElementById('btnSave'), btnLoad = document.getElementById('btnLoad');
  const btnExport = document.getElementById('btnExport'), btnImport = document.getElementById('btnImport'), btnReset = document.getElementById('btnReset');
  const timelineEl = document.getElementById('timeline'), btnReplay = document.getElementById('btnReplay'), btnExportLog = document.getElementById('btnExportLog');

  // ---------- Utilities ----------
  function now(){ return Date.now(); }
  function formatTime(s){
    const h = Math.floor(s/3600), m = Math.floor((s%3600)/60);
    return `${h}h ${m}m`;
  }
  function pushLog(msg, cls='sys'){
    const line = document.createElement('div');
    line.className = 'line '+cls;
    line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
    terminalEl.appendChild(line);
    terminalEl.scrollTop = terminalEl.scrollHeight;
    state.logs.push({t:Date.now(), msg, cls});
    if(state.logs.length>2000) state.logs.shift();
  }
  function pushTimeline(event){
    state.timeline.push({t:Date.now(), event});
    if(state.timeline.length>1000) state.timeline.shift();
    renderTimeline();
  }
  function renderTimeline(){
    timelineEl.innerHTML = state.timeline.slice(-60).map(e=>`[${new Date(e.t).toLocaleTimeString()}] ${e.event}`).join('\n');
  }

  // ---------- Mission generator ----------
  function genMission(difficulty=1){
    // difficulty influences length / subtasks; design a multi-step mission
    const phases = [
      {id:'recon', title:'Reconnaissance: collecte d\'indices', time: 8 + difficulty*6},
      {id:'analysis', title:'Analyse: corréler les flux', time: 12 + difficulty*8},
      {id:'forensic', title:'Forensic: trouver l\'anomalie', time: 10 + difficulty*6},
      {id:'mitigation', title:'Containment: neutraliser (simulé)', time: 8 + difficulty*6},
      {id:'report', title:'Rapport: préparer un document', time: 6 + difficulty*4}
    ];

    // choose subset to reach ~target minutes (we'll chain many missions)
    const steps = phases.filter((p,i)=> i < 3 + (difficulty>2?2:1));
    const mission = {
      id: 'mission_'+Date.now(),
      difficulty,
      title: `Opération Ghost Survey (diff ${difficulty})`,
      description: `Mission multi-étapes — ${steps.length} phases — environ ${steps.reduce((s,p)=>s+p.time,0)} minutes de contenu.`,
      steps: steps.map((p, idx)=>({
        id: p.id,
        title: p.title,
        desc: `${p.title} — tâche: ${["collecter","analyser","isoler","bloquer","documenter"][idx%5]} données fictives`,
        done:false,
        expectedTimeMin: p.time
      })),
      created: Date.now(),
      xpReward: 200 * difficulty
    };
    return mission;
  }

  // ---------- Packet model (simulated) ----------
  function forgePacket(type, target, prio){
    // packet is purely simulated; fields are fictional and safe
    const pkt = {
      id: 'pkt_'+Math.random().toString(36).slice(2,9),
      type, target, prio: +prio, created: Date.now(),
      signature: Math.random().toString(36).slice(2,10),
      status: 'forged'
    };
    state.packets.push(pkt);
    pushLog(`Paquet forgé: ${pkt.id} (${type}) -> ${target}`, 'sys');
    pushTimeline(`Forge ${pkt.id} type=${type} target=${target}`);
    return pkt;
  }
  function sendPacket(pkt){
    if(!pkt) return;
    pkt.status = 'sent';
    pkt.sentAt = Date.now();
    pushLog(`Paquet envoyé: ${pkt.id} -> ${pkt.target} (prio ${pkt.prio})`, 'sys');
    pushTimeline(`Send ${pkt.id} -> ${pkt.target}`);
    animatePacket(pkt);
    // simulated detection: higher priority and certain types increase trace
    const traceDelta = Math.max(0, Math.floor(pkt.prio/2) + (pkt.type==='exfil'?6: (pkt.type==='beacon'?4:1)));
    updateTrace(traceDelta);
    // mission-specific hooks
    evaluateMissionOnEvent({type:'send', pkt});
  }

  // ---------- Map packets animation ----------
  function animatePacket(pkt){
    // create a circle in SVG that travels along path to target node
    const svgNS = 'http://www.w3.org/2000/svg';
    const dot = document.createElementNS(svgNS, 'circle');
    dot.setAttribute('r', 6);
    dot.setAttribute('fill', pkt.type==='exfil'? '#ff9b9b' : '#8cffb8');
    dot.setAttribute('opacity', '0.95');
    packetsLayer.appendChild(dot);

    // determine path points depending on target
    const paths = {
      'dmz.akiranet': {start:{x:80,y:200}, end:{x:470,y:180}},
      'core': {start:{x:80,y:200}, end:{x:300,y:300}},
      'scanhub': {start:{x:80,y:200}, end:{x:260,y:80}},
      'ghost.akiranet': {start:{x:80,y:200}, end:{x:320,y:150}}
    };
    const pt = paths[pkt.target] || {start:{x:80,y:200}, end:{x:300,y:200}};
    const c1 = {x:(pt.start.x+pt.end.x)/2, y: pt.start.y - 40};
    const c2 = {x:(pt.start.x+pt.end.x)/2, y: pt.end.y + 40};
    let t = 0; const speed = 0.006 + Math.random()*0.006;
    function cubic(a,b,c,d,t){
      const mt = 1-t;
      return mt*mt*mt*a + 3*mt*mt*t*b + 3*mt*t*t*c + t*t*t*d;
    }
    function step(){
      t += speed;
      if(t>=1){
        packetsLayer.removeChild(dot);
        pushLog(`Paquet ${pkt.id} atteint ${pkt.target}`, 'sys');
        evaluatePacketArrival(pkt);
        return;
      }
      const x = cubic(pt.start.x,c1.x,c2.x,pt.end.x,t);
      const y = cubic(pt.start.y,c1.y,c2.y,pt.end.y,t);
      dot.setAttribute('cx', x);
      dot.setAttribute('cy', y);
      requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
  }

  // ---------- Trace and detection ----------
  function updateTrace(delta){
    state.trace = Math.max(0, Math.min(100, (state.trace||0)+delta));
    document.getElementById('stTrace') && (document.getElementById('stTrace').textContent = state.trace + '%');
    if(state.trace >= 100){
      pushLog('DETECTION MAX — Simulation: containment forcé. Mission interrompue (soft reset).', 'err');
      // simulate forced reset on detection
      softReset();
    }
  }

  // ---------- Mission evaluation hooks ----------
  function evaluateMissionOnEvent(ev){
    if(!state.mission) return;
    // simple heuristics: mark step as done when matching events
    const m = state.mission;
    m.steps.forEach(step=>{
      if(!step.done){
        if(step.id === 'recon' && ev.type==='send' && ev.pkt.type==='probe') step.done = true;
        if(step.id === 'analysis' && ev.type==='send' && ev.pkt.type==='handshake') step.done = true;
        if(step.id === 'forensic' && ev.type==='send' && ev.pkt.type==='forge') step.done = true;
        if(step.id === 'mitigation' && ev.type==='mitigate') step.done = true;
        if(step.id === 'report' && ev.type==='report') step.done = true;
      }
    });
    renderMissionUI();
    // mission complete
    if(m.steps.every(s=>s.done)){
      pushLog(`MISSION TERMINÉE: ${m.title} — +${m.xpReward} XP`, 'lyra');
      state.player.xp += m.xpReward;
      state.player.level = Math.max(1, Math.floor(1 + state.player.xp/500));
      pushTimeline(`MissionComplete ${m.id}`);
      grantPlayTime(5*60); // award some time estimate
      newMission(); // generate next mission to chain hours
    }
  }

  // ---------- Packet arrival evaluation (simulated) ----------
  function evaluatePacketArrival(pkt){
    // On arrival, maybe trigger events, create logs, drop artifacts
    if(pkt.type === 'exfil'){
      // risky: create detection event
      pushLog(`Traffic suspect détecté sur ${pkt.target} (simulé) — signature: ${pkt.signature}`, 'err');
      updateTrace(8);
    } else if(pkt.type === 'beacon'){
      pushLog(`Beacon reçu par ${pkt.target} — possible presence check (simulé).`, 'sys');
      updateTrace(3);
    } else {
      pushLog(`Paquet ${pkt.id} traité normalement.`, 'sys');
    }
    // create a "artifact" sample periodically
    if(Math.random() < 0.3){
      const sample = {id:'s_'+Math.random().toString(36).slice(2,8), content:'Sample artifact (simulated) ' + Math.random().toString(36).slice(2,8)};
      state.samples = state.samples || [];
      state.samples.push(sample);
      pushLog(`Artifact enregistré: ${sample.id}`, 'sys');
    }
  }

  // ---------- Forging / Sending UI handlers ----------
  btnForge.addEventListener('click', ()=>{
    const type = pktTypeEl.value, target = pktTargetEl.value||'dmz.akiranet', prio = pktPrioEl.value||5;
    const pkt = forgePacket(type, target, prio);
    pushLog(`Paquet ${pkt.id} prêt à l'envoi.`, 'sys');
    renderPacketsList();
  });

  btnSendPkt.addEventListener('click', ()=>{
    // send last forged packet
    const pkt = state.packets[state.packets.length-1];
    if(!pkt){ pushLog('Aucun paquet forgé.', 'err'); return; }
    sendPacket(pkt);
    renderPacketsList();
  });

  // ---------- Terminal commands ----------
  function handleCmd(line){
    const raw = String(line||'').trim();
    if(!raw) return;
    pushLog('> '+raw, 'user');
    pushTimeline(`cmd ${raw}`);
    const parts = raw.split(/\s+/);
    const cmd = parts[0].toLowerCase();
    const args = parts.slice(1);
    if(cmd === 'help'){
      pushLog('Commandes (simulation): help, mission, forge, send, inspect, block, replay, status, report, clear', 'sys');
    } else if(cmd === 'mission'){
      renderMissionUI();
    } else if(cmd === 'forge'){
      const type = args[0] || pktTypeEl.value;
      const target = args[1] || pktTargetEl.value || 'dmz.akiranet';
      forgePacket(type, target, pktPrioEl.value||5);
    } else if(cmd === 'send'){
      const id = args[0];
      if(id){
        const pkt = state.packets.find(p=>p.id===id);
        if(pkt) sendPacket(pkt); else pushLog('Paquet introuvable: '+id, 'err');
      } else {
        const pkt = state.packets[state.packets.length-1];
        if(pkt) sendPacket(pkt); else pushLog('Aucun paquet à envoyer.', 'err');
      }
    } else if(cmd === 'inspect'){
      const id = args[0];
      if(!id){ pushLog('inspect <id> — affiche meta simulée', 'sys'); return; }
      const pkt = state.packets.find(p=>p.id===id);
      if(pkt) pushLog(JSON.stringify(pkt), 'sys'); else pushLog('Paquet introuvable', 'err');
    } else if(cmd === 'block'){
      // simulated mitigation
      const target = args[0]||'unknown';
      pushLog(`Mitigation simulée appliquée sur ${target}`, 'sys');
      pushTimeline(`mitigate ${target}`);
      evaluateMissionOnEvent({type:'mitigate', target});
    } else if(cmd === 'status'){
      pushLog(`Player level ${state.player.level} · XP ${state.player.xp} · trace ${state.trace||0}%`, 'sys');
    } else if(cmd === 'replay'){
      doReplay();
    } else if(cmd === 'report'){
      pushLog('Génération de rapport simulé...', 'sys');
      pushTimeline('report');
      evaluateMissionOnEvent({type:'report'});
    } else if(cmd === 'clear'){
      terminalEl.innerHTML = '';
    } else {
      pushLog('Commande inconnue dans ce simulateur. Tape help.', 'err');
    }
  }

  // ---------- Mission UI ----------
  function renderMissionUI(){
    if(!state.mission) return;
    missionText.textContent = state.mission.description;
    const steps = state.mission.steps;
    o1.textContent = steps[0] ? steps[0].desc : '';
    o2.textContent = steps[1] ? steps[1].desc : '';
    o3.textContent = steps[2] ? steps[2].desc : '';
    b1.className = 'bullet' + (steps[0] && steps[0].done ? ' done':'' );
    b2.className = 'bullet' + (steps[1] && steps[1].done ? ' done':'' );
    b3.className = 'bullet' + (steps[2] && steps[2].done ? ' done':'' );
    xpEl.textContent = state.player.xp;
    xpBar.style.width = Math.min(100, (state.player.xp % 500)/5) + '%';
    document.getElementById('playerLevel').textContent = state.player.level;
    playTimeEl.textContent = formatTime(state.player.playSeconds || 0);
  }

  // ---------- Start / Next mission ----------
  function newMission(){
    state.mission = genMission(Math.min(4, Math.max(1, Math.floor(state.player.level/2)+1)));
    pushLog('Nouvelle mission générée: ' + state.mission.title, 'lyra');
    pushTimeline('newMission ' + state.mission.id);
    renderMissionUI();
  }

  // ---------- Replay / timeline ----------
  function doReplay(){
    pushLog('Replay simulation (fictif) — relecture des dernières actions', 'sys');
    // just print last timeline events
    const last = state.timeline.slice(-30);
    last.forEach(e=> pushLog(`[Repl] ${new Date(e.t).toLocaleTimeString()} ${e.event}`, 'sys'));
  }

  // ---------- Save / Load ----------
  function saveState(){
    try{
      const snapshot = JSON.stringify(state);
      localStorage.setItem(state.autosaveKey, snapshot);
      document.getElementById('autosaveStatus').textContent = 'OK';
      pushLog('Partie sauvegardée localement.', 'sys');
    }catch(e){
      pushLog('Erreur sauvegarde: ' + e.message, 'err');
    }
  }
  function loadState(){
    try{
      const raw = localStorage.getItem(state.autosaveKey);
      if(!raw) { pushLog('Aucune sauvegarde trouvée.', 'err'); return; }
      const obj = JSON.parse(raw);
      // merge minimal
      state.player = obj.player || state.player;
      state.mission = obj.mission || state.mission;
      state.packets = obj.packets || state.packets;
      state.timeline = obj.timeline || state.timeline;
      state.logs = obj.logs || state.logs;
      state.samples = obj.samples || state.samples;
      pushLog('Sauvegarde chargée.', 'sys');
      renderMissionUI();
      renderPacketsList();
    }catch(e){
      pushLog('Erreur chargement: ' + e.message, 'err');
    }
  }

  // ---------- Export/Import ----------
  btnExport.addEventListener('click', ()=>{
    const data = JSON.stringify(state);
    const blob = new Blob([data], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'ctc_packetforge_save.json'; a.click();
    URL.revokeObjectURL(url);
    pushLog('Export de la sauvegarde initié.', 'sys');
  });
  btnImport.addEventListener('click', ()=>{
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'application/json';
    input.onchange = e=>{
      const f = e.target.files[0];
      const r = new FileReader();
      r.onload = ev=>{
        try{
          const obj = JSON.parse(ev.target.result);
          // naive replace
          Object.assign(state, obj);
          pushLog('Import OK.', 'sys');
          renderMissionUI();
        }catch(err){ pushLog('Import failed: '+err.message, 'err'); }
      };
      r.readAsText(f);
    };
    input.click();
  });

  // ---------- Reset ----------
  btnReset.addEventListener('click', ()=>{
    if(confirm('Reset campagne ? Tout progrès local sera perdu.')){
      localStorage.removeItem(state.autosaveKey);
      location.reload();
    }
  });

  // ---------- Packets list render (small) ----------
  function renderPacketsList(){
    // small debug: list last 8
    // but keep it light — we'll put short info in timeline instead
    // also update samples
    document.getElementById('toolsUnlocked').textContent = 'Basic Forge';
  }

  // ---------- Replay export logs ----------
  btnExportLog.addEventListener('click', ()=>{
    const blob = new Blob([state.logs.map(l=>`${new Date(l.t).toLocaleString()} ${l.msg}`).join('\n')], {type:'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'ctc_packetforge_log.txt'; a.click(); URL.revokeObjectURL(url);
    pushLog('Export du log initié.', 'sys');
  });

  // ---------- time tick & autosave ----------
  setInterval(()=>{
    if(state.paused) return;
    const nowT = now();
    const delta = Math.floor((nowT - state.lastTick)/1000);
    if(delta>0){
      state.player.playSeconds = (state.player.playSeconds||0) + delta;
      state.lastTick = nowT;
      // autosave every 20 seconds
      if((state.player.playSeconds % 20) === 0) saveState();
      document.getElementById('playTime').textContent = formatTime(state.player.playSeconds);
    }
  },1000);

  // ---------- soft reset ----------
  function softReset(){
    // clear mission progress but preserve overall xp
    state.mission && state.mission.steps.forEach(s=> s.done = false);
    state.trace = 0;
    document.getElementById('stTrace') && (document.getElementById('stTrace').textContent = '0%');
    pushTimeline('softReset');
    renderMissionUI();
  }

  // ---------- initial boot ----------
  function boot(){
    pushLog('Boot simulation — Packet Forge (CrackTheCode) — sandbox pédagogique', 'sys');
    pushLog('Lyra.exe active — mode éducatif', 'lyra');
    newMission();
    saveState();
  }

  // ---------- UI wiring ----------
  btnRun.addEventListener('click', ()=> handleCmd(cmdEl.value) );
  cmdEl.addEventListener('keydown', e=>{ if(e.key === 'Enter') { handleCmd(cmdEl.value); cmdEl.value=''; } });

  document.getElementById('btnPause').addEventListener('click', ()=>{
    state.paused = !state.paused;
    btnPause.textContent = state.paused ? 'Resume' : 'Pause';
    pushLog(state.paused ? 'Simulation en pause' : 'Simulation reprise', 'sys');
  });

  document.getElementById('btnSave').addEventListener('click', saveState);
  document.getElementById('btnLoad').addEventListener('click', loadState);

  btnReplay.addEventListener('click', ()=> doReplay());

  // simple click handlers for forge/send
  document.getElementById('btnSendPkt').addEventListener('click', ()=>{
    const pkt = state.packets[state.packets.length-1];
    if(!pkt){ pushLog('Aucun paquet forgé.', 'err'); return; }
    sendPacket(pkt);
  });

  // ----- start -----
  boot();

  // Expose state for dev console (optional)
  window._CTC = {state, forgePacket, sendPacket, saveState, loadState};

})();
</script>
</body>
</html>
